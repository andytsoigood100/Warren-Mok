import streamlit as st
import random
import datetime

# Set page configuration
st.set_page_config(page_title="è«è²ç‰¹ å¯¬Sirå ±å‘Šç”Ÿæˆå™¨",
                   page_icon="ğŸ“ˆ",
                   layout="centered",
                   initial_sidebar_state="collapsed")

# åˆå§‹åŒ– session state
if 'report' not in st.session_state:
    st.session_state.report = ''

# è©•ç´šé¸é …ï¼ˆç”¨æ–¼éš¨æ©ŸæŠ½å–ï¼‰
buy_options = [
    'å¼·çƒˆè²·å…¥', 'å¢æŒ', 'è·‘èµ¢å¤§ç›¤', 'è¨“èº«è²·å…¥', 'å€Ÿçˆ†å­–å±•è²·å…¥', 'ç„¡è…¦è¡é«˜',
    'å””è²·èµ°é›', 'æ§“æ¡¿çˆ†å‡', 'ç‡éŒ¯ç…§Hold', 'å‡åˆ°æœˆçƒ', 'èŠå®¶é€éŒ¢', 'All-inç­‰é€€ä¼‘',
    'å‡å°±è¿½, è·Œå°±æº, å‡ºç³§å°±å…¥è²¨, æ­¢è•ä¿‚å¤šé¤˜, å›èª¿å§ä¿‚ç‰¹åƒ¹, æ­¢è³ºéƒ½ä¿‚å¤šé¤˜, é«˜è™•æœªç®—é«˜, å¿ƒé›„æ—¢å°±è²·åŸ‹call',
    'ç‡éŒ¯å°±é•·æ¸ï¼Œç¸½æœƒè¿”å®¶é„‰', 'åˆ¥äººææ‡¼æˆ‘æºè²¨ï¼Œåˆ¥äººæºè²¨æˆ‘ææ‡¼',
    'åˆ«äººææƒ§æˆ‘All-inï¼Œåˆ«äººAll-inæˆ‘é€€ä¼‘', 'å›èª¿å°±æ˜¯ä¸Šè»Šæ©Ÿæœƒï¼Œè¶Šè·Œè¶Šè²·ï¼Œè²·åˆ°ç ´ç”¢ï¼'
]

sell_options = [
    'è³£å‡º', 'æ²½å”®è©•åƒ¹', 'æ¥µåº¦æ‚²è§€', 'ç­‰ç ´ç”£', 'ç­‰è®Šç‰†ç´™', 'IFCå¤©å°è¦‹', 'ç‡æ·¡åˆ°ä»†è¡—', 'è·Œåˆ°å°ä½å±å¹•å–Š',
    'å””æ²½ç­‰æ­»', 'æ§“æ¡¿çˆ†ç…²', 'æ’å¤§2.0', 'è·Œåˆ°åœ°æ ¸',
    'åˆ¥äººè²ªå©ªæˆ‘è·‘è·¯ï¼Œåˆ¥äººè·‘è·¯æˆ‘æŠ„åº•â€”â€”ç„¶å¾Œç¹¼çºŒè·Œ',
    'åå½ˆå°±æ˜¯é€ƒå‘½æ©Ÿæœƒï¼Œå†ä¸è·‘å°±çœŸæˆç™¾å¹´é•·éŸ­è‚¡æ±',
    'è³¬æˆ¶ç´…å½¤å½¤ï¼Ÿé‚£æ˜¯èŠå®¶åœ¨æ”¾ç…™èŠ±ï¼Œæ…¶ç¥ä½ éŸ­èœè™§éŒ¢',
    'çŸ­ç·šè®Šé•·ç·šï¼Œé•·ç·šè®Šç¶­æ¬Šï¼Œç¶­æ¬Šè®Šä½›ç³»', 'æ°¸ä¸–åšå¤–è³£ä»”'
]

# æ ¹æ“šåƒ¹æ ¼è®ŠåŒ–è‡ªå‹•è¨­å®šè©•ç´šè®Šå‹•èˆ‡æœ€çµ‚è©•ç´š
def get_rating_change_and_final(old_price, new_price):
    if new_price > old_price:
        return "ä¸Šå‡", "èˆ‡å¤§å¸‚åŒæ­¥"
    elif new_price == old_price:
        return "ä¸­æ€§", "ç¶­æŒä¸­æ€§"
    else:
        return "ä¸‹é™", "è·‘è¼¸å¤§å¸‚ä¹æ¢è¡—"

# å®šç¾©ç”Ÿæˆå ±å‘Šçš„å‡½æ•¸
def generate_report():
    company_name = st.session_state.company_name
    old_price = st.session_state.old_price
    new_price = st.session_state.new_price

    # é©—è­‰å¿…å¡«æ¬„ä½
    if not company_name:
        st.error("è«‹å¡«å¯«å…¬å¸åç¨±")
        return

    # ç¢ºä¿åƒ¹æ ¼æ˜¯æœ‰æ•ˆæ•¸å­—
    try:
        old_price = float(old_price)
        new_price = float(new_price)
    except ValueError:
        st.error("è«‹è¼¸å…¥æœ‰æ•ˆçš„åƒ¹æ ¼æ•¸å­—")
        return

    # è¨ˆç®—è®Šå‹•ç™¾åˆ†æ¯”
    if old_price != 0:
        change_percent = ((new_price - old_price) / old_price) * 100
    else:
        change_percent = 0.0
    percent_text = f"{abs(change_percent):.2f}%"

    price_direction = "ä¸Šå‡" if new_price > old_price else "ä¸‹é™" if new_price < old_price else "æŒå¹³"

    # è‡ªå‹•é¸æ“‡è©•ç´š
    rating = random.choice(buy_options if new_price > old_price else sell_options if new_price < old_price else [random.choice(buy_options)])
    rating_change, final_rating = get_rating_change_and_final(old_price, new_price)

    # è«è²ç‰¹çš„å­¸æ­·èƒŒæ™¯
    background = "ç‰›è§’é‡‘æœƒå“¡ï¼Œæƒ åº·Yuuè³‡æ·±æœƒå“¡ï¼Œ247fitnessé»‘é‡‘æœƒå“¡ï¼ŒHKTVmallå‰µå§‹æœƒå“¡ï¼Œéº¥ç•¶å¥´åª½å’ªæœƒæœƒå“¡ï¼Œé¦™æ¸¯å¤§å­¸spaceç³»ç•¢æ¥­ï¼Œé¦™æ¸¯ç†å·¥å¤§å­¸ccç³»ç•¢æ¥­ã€‚"

    # ç”Ÿæˆå ±å‘Šæ–‡æœ¬
    report = (
        f"è‘—åæŠ•è³‡äººè«è²ç‰¹çµ¦äºˆ: {company_name} çš„ç›®æ¨™åƒ¹æ ¼ "
        f"å¾ {old_price:.2f} å…ƒèª¿æ•´è‡³ {new_price:.2f} å…ƒï¼Œ{price_direction} {percent_text}ã€‚\n"
        f"ç¶­æŒ {rating} è©•åƒ¹ã€‚\n"
        f"è©•ç´š {rating_change} è‡³ã€Œ{final_rating}ã€ã€‚\n\n"
        f"â€”â€”è«è²ç‰¹\n{background}")

    # ä¿å­˜å ±å‘Šä¸¦é¡¯ç¤º
    st.session_state.report = report
    st.success("å ±å‘Šå·²è‡ªå‹•ç”Ÿæˆ")


# è¨­ç½®æ‡‰ç”¨ç¨‹åºæ¨™é¡Œå’Œä»‹ç´¹
st.title("è«è²ç‰¹å¯Sirå ±å‘Šç”Ÿæˆå™¨")
st.write("è¼¸å…¥è‚¡ç¥¨ä¿¡æ¯ï¼Œè‡ªå‹•ç”Ÿæˆè«è²ç‰¹å¯Sirå°ˆæ¥­åˆ†æå ±å‘Š")

# å‰µå»ºè¼¸å…¥éƒ¨ä»¶
with st.container():
    st.subheader("åŸºæœ¬ä¿¡æ¯")
    company_name = st.text_input("å…¬å¸åç¨±:", key="company_name")

    col1, col2 = st.columns(2)
    with col1:
        old_price = st.number_input("èˆŠåƒ¹æ ¼ (å…ƒ):",
                                    min_value=0.0,
                                    value=0.0,
                                    step=0.01,
                                    format="%.2f",
                                    key="old_price")
    with col2:
        new_price = st.number_input("æ–°åƒ¹æ ¼ (å…ƒ):",
                                    min_value=0.0,
                                    value=0.0,
                                    step=0.01,
                                    format="%.2f",
                                    key="new_price")

# æ“ä½œæŒ‰éˆ•
st.markdown("---")
generate_button = st.button("ç”Ÿæˆå ±å‘Š", use_container_width=True, on_click=generate_report)

# å ±å‘Šé¡¯ç¤ºå€åŸŸ
if st.session_state.report:
    st.markdown("### ç”Ÿæˆçš„å ±å‘Š")
    st.text_area("å ±å‘Šå…§å®¹",
                 value=st.session_state.report,
                 height=150,
                 key="display_report",
                 disabled=True,
                 label_visibility="collapsed")

    # é¡¯ç¤ºå ±å‘Šç”Ÿæˆçš„æ™‚é–“æˆ³ä½œç‚ºåƒè€ƒ
    now = datetime.datetime.now()
    st.caption(f"å ±å‘Šç”Ÿæˆæ™‚é–“: {now.strftime('%Y-%m-%d %H:%M:%S')}")

# æ·»åŠ åº•éƒ¨èªªæ˜
st.markdown("---")
st.caption("æœ¬æ‡‰ç”¨åƒ…ä¾›å¨›æ¨‚ï¼Œä¸æ§‹æˆä»»ä½•æŠ•è³‡å»ºè­°ï¼Œæˆ‘å±Œä½ è€æ¯ã€‚")
